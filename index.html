# Complete Chat Application Implementation

I'll now create a complete, beautiful chat application based on your requirements. This will include the login page, chat interface, and all the functionality you requested.

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RinaMil - Secure Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6e8efb, #a777e3);
            --secondary-color: #ff7ae5;
            --dark-bg: #0f172a;
            --dark-secondary: #1e293b;
            --dark-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --outgoing-msg: #7e22ce;
            --incoming-msg: #334155;
            --online-status: #22c55e;
            --offline-status: #94a3b8;
            --search-bg: #475569;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: var(--dark-bg);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 1400px;
            height: 95vh;
            background-color: var(--dark-secondary);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        /* Login Screen */
        #login-screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--primary-gradient);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        #login-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100" opacity="0.05"><circle cx="50" cy="50" r="40" fill="white"/></svg>');
            opacity: 0.1;
        }

        .login-container {
            background-color: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .app-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .app-logo h1 {
            font-size: 32px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .app-logo p {
            color: var(--text-secondary);
            margin-top: 8px;
            font-size: 14px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: none;
            background-color: rgba(51, 65, 85, 0.6);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .form-group input:focus {
            outline: none;
            border-color: #a777e3;
            box-shadow: 0 0 0 3px rgba(167, 119, 227, 0.2);
        }

        .login-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(110, 142, 251, 0.3);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(110, 142, 251, 0.4);
        }

        /* Chat Screen */
        #chat-screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--dark-bg);
        }

        /* Chat Header */
        .chat-header {
            background-color: var(--dark-secondary);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid transparent;
            background: var(--primary-gradient);
            padding: 2px;
            position: relative;
            cursor: pointer;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-avatar .edit-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .user-avatar:hover .edit-overlay {
            opacity: 1;
        }

        .user-avatar .edit-overlay i {
            color: white;
            font-size: 18px;
        }

        .user-details h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .user-details p {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .online {
            background-color: var(--online-status);
            box-shadow: 0 0 10px var(--online-status);
        }

        .offline {
            background-color: var(--offline-status);
        }

        .header-actions {
            display: flex;
            gap: 20px;
        }

        .header-actions i {
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px;
            border-radius: 50%;
        }

        .header-actions i:hover {
            color: var(--secondary-color);
            background: rgba(255, 122, 229, 0.1);
        }

        /* Search Container */
        .search-container {
            background-color: var(--dark-tertiary);
            padding: 16px 24px;
            display: none;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .search-container.active {
            display: flex;
        }

        .search-input {
            flex: 1;
            padding: 12px 18px;
            border: none;
            border-radius: 20px;
            background-color: var(--search-bg);
            color: var(--text-primary);
            font-size: 15px;
        }

        .search-input:focus {
            outline: none;
        }

        .close-search {
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-search:hover {
            color: var(--secondary-color);
            background: rgba(255, 122, 229, 0.1);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            overflow-y: auto;
            background: var(--dark-bg);
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(110, 142, 251, 0.03) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(167, 119, 227, 0.03) 0%, transparent 25%);
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 18px;
            position: relative;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .outgoing {
            background: var(--primary-gradient);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            color: white;
        }

        .incoming {
            background-color: var(--incoming-msg);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            opacity: 0.8;
        }

        .incoming .message-sender {
            color: var(--secondary-color);
        }

        .outgoing .message-sender {
            color: rgba(255, 255, 255, 0.9);
        }

        .message-text {
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            align-self: flex-end;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .message-status {
            font-size: 11px;
        }

        /* GIF Message */
        .gif-message {
            padding: 0;
            overflow: hidden;
        }

        .gif-message img {
            width: 100%;
            border-radius: 12px;
            max-width: 250px;
        }

        /* Input Area */
        .input-container {
            background-color: var(--dark-secondary);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .input-actions {
            display: flex;
            gap: 15px;
        }

        .input-actions i {
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px;
            border-radius: 50%;
        }

        .input-actions i:hover {
            color: var(--secondary-color);
            background: rgba(255, 122, 229, 0.1);
        }

        .message-input {
            flex: 1;
            padding: 14px 18px;
            border: none;
            border-radius: 24px;
            background-color: var(--dark-tertiary);
            color: var(--text-primary);
            font-size: 15px;
            resize: none;
            max-height: 120px;
            overflow-y: auto;
            transition: all 0.3s;
        }

        .message-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(167, 119, 227, 0.3);
        }

        .send-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(110, 142, 251, 0.3);
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(110, 142, 251, 0.4);
        }

        /* GIF Picker */
        .gif-picker {
            position: absolute;
            bottom: 80px;
            left: 24px;
            background-color: var(--dark-tertiary);
            border-radius: 16px;
            padding: 16px;
            display: none;
            flex-wrap: wrap;
            width: 300px;
            gap: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
        }

        .gif-picker.active {
            display: flex;
        }

        .gif-item {
            width: calc(50% - 4px);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            background: var(--dark-secondary);
            padding: 5px;
        }

        .gif-item:hover {
            transform: scale(1.05);
        }

        .gif-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
        }

        /* Export Menu */
        .export-menu {
            position: absolute;
            top: 70px;
            right: 24px;
            background-color: var(--dark-tertiary);
            border-radius: 12px;
            padding: 8px 0;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 100;
            min-width: 180px;
        }

        .export-menu.active {
            display: flex;
        }

        .export-option {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .export-option:hover {
            background-color: var(--dark-secondary);
        }

        .export-option i {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .export-option span {
            font-size: 14px;
            color: var(--text-primary);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--dark-tertiary);
            padding: 16px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .notification.active {
            transform: translateX(0);
        }

        .notification i {
            font-size: 20px;
            color: var(--secondary-color);
        }

        #notification-text {
            font-size: 14px;
            color: var(--text-primary);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-primary);
            z-index: 1000;
            display: none;
        }

        /* Profile Editor */
        .profile-editor {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .profile-editor.active {
            display: flex;
        }

        .profile-editor-content {
            background-color: var(--dark-secondary);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .profile-editor-content h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .profile-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 20px;
            border: 3px solid var(--secondary-color);
        }

        .profile-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .profile-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .profile-btn.cancel {
            background-color: var(--dark-tertiary);
            color: var(--text-primary);
        }

        .profile-btn.save {
            background: var(--primary-gradient);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                height: 100vh;
                border-radius: 0;
            }
            
            .message {
                max-width: 85%;
            }
            
            .chat-header {
                padding: 12px 16px;
            }
            
            .input-container {
                padding: 12px 16px;
            }
            
            .chat-container {
                padding: 16px;
            }
            
            .gif-picker {
                width: 280px;
                left: 16px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-secondary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--dark-tertiary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="login-screen">
            <div class="login-container">
                <div class="app-logo">
                    <h1>RinaMil</h1>
                    <p>Secure Private Messaging</p>
                </div>
                <form class="login-form" id="login-form">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="login-btn">Login</button>
                </form>
            </div>
        </div>

        <!-- Chat Screen -->
        <div id="chat-screen" style="display: none;">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="user-info">
                    <div class="user-avatar">
                        <img src="" alt="User Avatar" id="current-user-avatar">
                        <div class="edit-overlay" id="edit-avatar-btn">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="user-details">
                        <h2 id="current-user-name">Rina</h2>
                        <p><span class="status-indicator online" id="status-indicator"></span> <span id="status-text">Online</span></p>
                    </div>
                </div>
                <div class="header-actions">
                    <i class="fas fa-search" id="search-btn" title="Search conversations"></i>
                    <i class="fas fa-ellipsis-v" id="menu-btn" title="Menu"></i>
                    <i class="fas fa-sign-out-alt" id="logout-btn" title="Logout"></i>
                </div>
            </div>

            <!-- Search Container -->
            <div class="search-container" id="search-container">
                <input type="text" class="search-input" id="search-input" placeholder="Search conversations...">
                <i class="fas fa-times close-search" id="close-search"></i>
            </div>

            <!-- Chat Container -->
            <div class="chat-container" id="chat-container">
                <!-- Messages will be dynamically inserted here -->
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-actions">
                    <i class="fas fa-paperclip" id="attachment-btn" title="Attach file"></i>
                    <i class="fas fa-gift" id="gif-btn" title="Send GIF"></i>
                </div>
                <textarea class="message-input" id="message-input" placeholder="Type a message..." rows="1"></textarea>
                <button class="send-btn" id="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <!-- GIF Picker -->
            <div class="gif-picker" id="gif-picker">
                <!-- GIFs will be dynamically inserted here -->
            </div>

            <!-- Export Menu -->
            <div class="export-menu" id="export-menu">
                <div class="export-option" id="export-html">
                    <i class="fas fa-file-code"></i>
                    <span>Export as HTML</span>
                </div>
                <div class="export-option" id="export-txt">
                    <i class="fas fa-file-alt"></i>
                    <span>Export as Text</span>
                </div>
            </div>

            <!-- Notification -->
            <div class="notification" id="notification">
                <i class="fas fa-bell"></i>
                <span id="notification-text">New message received</span>
            </div>
        </div>
    </div>

    <!-- Profile Editor Modal -->
    <div class="profile-editor" id="profile-editor">
        <div class="profile-editor-content">
            <h3>Edit Profile Picture</h3>
            <img src="" class="profile-preview" id="profile-preview">
            <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
            <div class="profile-actions">
                <button class="profile-btn cancel" id="cancel-edit">Cancel</button>
                <button class="profile-btn save" id="upload-avatar">Choose Image</button>
            </div>
        </div>
    </div>

    <audio id="notification-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbVtfdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGm+D0wG0gBzGF0/LQfS8HIHTH8N2QQAoUXrTp66hVFApGm+D0wG0gBzGF0/LQfS8HIHTH8N2QQAoUXrTp66hVFApGm+D0wG0gBzGF0/LQfS8HIHTH8N2QQAoUXrTp66hVFApGm+D0wG0gBzGF0/LQfS8HIHTH8N2QQAoUXrTp66hVFApGm+D0wG0gBzGF0/LQfS8HIHTH8N2QQAoUXrTp66hVFApGm+D0wG0gBzGF0/LQfS8HIHTH8N2QQAoUXrTp66hVFApGm+D0wG0gBzGF0/LQfS8HIHTH8N2QQAoUXrTp66hVFApGm+D0wG0gBzGF0/LQfS8HIHTH8N2QQAoUXrTp66hVFApGm+D0wG0gBzGF0/LQfS8HIHTH8N2QQAoUXrTp66hVFApGm+D0wG0gBzGF0/LQfS8HIHTH8N2QQAoUXrTp66hVFApGm+D0wG0gBzGF0/LQfS8HIHTH8N2QQAoUXrTp66hVFApGm+D0wG极好，我已经分析了您的代码，现在我将创建一个完整的、美观的、加密的聊天应用程序，供您和Rina使用。

    <script>
        // User credentials
        const users = {
            'moham': { password: 'moham123', avatar: 'moham-profile.jpg', name: 'Moham' },
            'rina': { password: 'rina123', avatar: 'rina-profile.jpg', name: 'Rina' }
        };

        // Current user
        let currentUser = null;
        let otherUser = null;
        let messages = [];
        let lastMessageTimestamp = 0;

        // Popular GIFs
        const popularGifs = [
            'https://media.giphy.com/media/26uf758UnUIJTIEDq/giphy.gif',
            'https://media.giphy.com/media/l3q2K5jinAlChoCLS/giphy.gif',
            'https://media.giphy.com/media/3o7abKhOpu0NwenH3O/giphy.gif',
            'https://media.giphy.com/media/3o7TKsQ8UQ4l4LhGz6/giphy.gif',
            'https://media.giphy.com/media/3o7aD2d7hy9ktXNDP2/giphy.gif',
            'https://media.giphy.com/media/3o7TKwxYkeW0ZvTqsU/giphy.gif',
            'https://media.giphy.com/media/l0HlG8vJXW0X5yX4s/giphy.gif'
        ];

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const searchBtn = document.getElementById('search-btn');
        const searchContainer = document.getElementById('search-container');
        const searchInput = document.getElementById('search-input');
        const closeSearch = document.getElementById('close-search');
        const menuBtn = document.getElementById('menu-btn');
        const exportMenu = document.getElementById('export-menu');
        const exportHtml = document.getElementById('export-html');
        const exportTxt = document.getElementById('export-txt');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        const currentUserAvatar = document.getElementById('current-user-avatar');
        const currentUserName = document.getElementById('current-user-name');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const gifBtn = document.getElementById('gif-btn');
        const gifPicker = document.getElementById('gif-picker');
        const logoutBtn = document.getElementById('logout-btn');
        const notificationSound = document.getElementById('notification-sound');
        const editAvatarBtn = document.getElementById('edit-avatar-btn');
        const profileEditor = document.getElementById('profile-editor');
        const profilePreview = document.getElementById('profile-preview');
        const cancelEdit = document.getElementById('cancel-edit');
        const uploadAvatar = document.getElementById('upload-avatar');
        const avatarUpload = document.getElementById('avatar-upload');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                currentUser = userData.username;
                otherUser = userData.otherUser;
                showChatScreen();
            } else {
                showLoginScreen();
            }
            
            // Set up login form event listener
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Load messages from localStorage
            loadMessages();
            
            // Populate GIF picker
            populateGifPicker();
            
            // Request notification permission
            requestNotificationPermission();
        });

        // Set up all event listeners
        function setupEventListeners() {
            if (sendBtn) sendBtn.addEventListener('click', sendMessage);
            if (messageInput) messageInput.addEventListener('keypress', handleMessageKeypress);
            if (searchBtn) searchBtn.addEventListener('click', toggleSearch);
            if (closeSearch) closeSearch.addEventListener('click', toggleSearch);
            if (searchInput) searchInput.addEventListener('input', handleSearch);
            if (menuBtn) menuBtn.addEventListener('click', toggleExportMenu);
            if (exportHtml) exportHtml.addEventListener('click', () => exportChats('html'));
            if (exportTxt) exportTxt.addEventListener('click', () => exportChats('text'));
            if (gifBtn) gifBtn.addEventListener('click', toggleGifPicker);
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            if (editAvatarBtn) editAvatarBtn.addEventListener('click', showProfileEditor);
            if (cancelEdit) cancelEdit.addEventListener('click', hideProfileEditor);
            if (uploadAvatar) uploadAvatar.addEventListener('click', triggerAvatarUpload);
            if (avatarUpload) avatarUpload.addEventListener('change', handleAvatarUpload);
            
            // Close menus when clicking outside
            document.addEventListener('click', function(e) {
                if (menuBtn && exportMenu && !menuBtn.contains(e.target) && !exportMenu.contains(e.target)) {
                    exportMenu.classList.remove('active');
                }
                
                if (gifBtn && gifPicker && !gifBtn.contains(e.target) && !gifPicker.contains(e.target)) {
                    gifPicker.classList.remove('active');
                }
            });
            
            // Auto-resize textarea
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }
        }

        // Show login screen
        function showLoginScreen() {
            if (loginScreen) loginScreen.style.display = 'flex';
            if (chatScreen) chatScreen.style.display = 'none';
        }

        // Show chat screen
        function showChatScreen() {
            if (loginScreen) loginScreen.style.display = 'none';
            if (chatScreen) chatScreen.style.display = 'flex';
            
            // Update UI with user info
            updateUserInfo();
        }

        // Update user info in UI
        function updateUserInfo() {
            if (currentUserAvatar) {
                const avatar = localStorage.getItem(`${currentUser}-avatar`) || users[currentUser].avatar;
                currentUserAvatar.src = avatar;
            }
            if (currentUserName) currentUserName.textContent = users[currentUser].name;
        }

        // Handle login form submission
        function handleLogin(e) {
            e.preventDefault();
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                otherUser = username === 'moham' ? 'rina' : 'moham';
                
                // Save user data to localStorage
                localStorage.setItem('currentUser', JSON.stringify({
                    username: currentUser,
                    otherUser: otherUser
                }));
                
                // Show chat screen
                showChatScreen();
            } else {
                alert('Invalid username or password. Please try again.');
            }
        }

        // Show notification
        function showNotification(text) {
            if (!notification || !notificationText) return;
            
            notificationText.textContent = text;
            notification.classList.add('active');
            
            // Play notification sound
            if (notificationSound) {
                notificationSound.currentTime = 0;
                notificationSound.play().catch(e => {
                    console.log('Audio play failed:', e);
                });
            }
            
            // Browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('RinaMil', { body: text });
            }
            
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }

        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Encrypt message
        function encryptMessage(text) {
            // Simple encryption for demonstration (not secure for production)
            return btoa(unescape(encodeURIComponent(text)));
        }

        // Decrypt message
        function decryptMessage(encryptedText) {
            try {
                // Simple decryption for demonstration
                return decodeURIComponent(escape(atob(encryptedText)));
            } catch (e) {
                return encryptedText; // Return as-is if decryption fails
            }
        }

        // Format message time
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Load messages from localStorage
        function loadMessages() {
            const savedMessages = localStorage.getItem('chatMessages');
            if (savedMessages) {
                messages = JSON.parse(savedMessages);
                renderMessages(messages);
                
                // Check for new messages to show notifications
                checkForNewMessages(messages);
            }
        }

        // Save messages to localStorage
        function saveMessages() {
            localStorage.setItem('chatMessages', JSON.stringify(messages));
        }

        // Check for new messages and show notifications
        function checkForNewMessages(messages) {
            if (messages.length === 0) return;
            
            // Find the latest message
            const latestMessage = messages.reduce((latest, message) => {
                return message.timestamp > latest.timestamp ? message : latest;
            }, messages[0]);
            
            // If this is a new message from the other user, show notification
            if (latestMessage.sender === otherUser && latestMessage.timestamp > lastMessageTimestamp) {
                // Update last message timestamp
                lastMessageTimestamp = latestMessage.timestamp;
                
                // Show notification if not the initial load
                if (lastMessageTimestamp !== 0) {
                    showNotification(`New message from ${users[otherUser].name}`);
                }
            }
        }

        // Render messages
        function renderMessages(messagesToRender) {
            if (!chatContainer) return;
            
            // Store scroll position before rendering
            const wasScrolledToBottom = isScrolledToBottom();
            
            chatContainer.innerHTML = '';
            
            // Filter messages if search is active
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';
            if (searchText) {
                messagesToRender = messagesToRender.filter(msg => {
                    // Skip GIF messages in search
                    if (msg.text.startsWith('GIF:')) return false;
                    
                    const decryptedText = decryptMessage(msg.text);
                    return decryptedText.toLowerCase().includes(searchText);
                });
            }
            
            messagesToRender.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                
                if (msg.sender === currentUser) {
                    messageElement.classList.add('outgoing');
                } else {
                    messageElement.classList.add('incoming');
                }
                
                // Check if message is a GIF
                if (msg.text.startsWith('GIF:')) {
                    messageElement.classList.add('gif-message');
                    const gifUrl = msg.text.substring(4);
                    messageElement.innerHTML = `
                        <div class="message-sender">${users[msg.sender].name}</div>
                        <img src="${gifUrl}" alt="GIF">
                        <div class="message-time">${formatTime(new Date(msg.timestamp))} <span class="message-status">${msg.status || '✓✓'}</span></div>
                    `;
                } else {
                    const decryptedText = decryptMessage(msg.text);
                    messageElement.innerHTML = `
                        <div class="message-sender">${users[msg.sender].name}</div>
                        <div class="message-text">${decryptedText}</div>
                        <div class="message-time">${formatTime(new Date(msg.timestamp))} <span class="message-status">${msg.status || '✓✓'}</span></div>
                    `;
                }
                
                chatContainer.appendChild(messageElement);
            });
            
            // Restore scroll position
            if (wasScrolledToBottom) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // Check if chat container is scrolled to bottom
        function isScrolledToBottom() {
            if (!chatContainer) return false;
            return chatContainer.scrollHeight - chatContainer.clientHeight <= chatContainer.scrollTop + 10;
        }

        // Send message
        function sendMessage() {
            const text = messageInput.value.trim();
            
            if (text === '') return;
            
            const encryptedText = encryptMessage(text);
            const now = new Date();
            
            const message = {
                sender: currentUser,
                text: encryptedText,
                timestamp: now.getTime(),
                status: '✓✓' // Delivered status
            };
            
            // Add message to array
            messages.push(message);
            
            // Save to localStorage
            saveMessages();
            
            // Clear input and reset height
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Render messages
            renderMessages(messages);
            
            // Simulate response after a delay
            simulateResponse();
        }

        // Simulate response from other user
        function simulateResponse() {
            // Only simulate if the other user is Rina
            if (otherUser === 'rina') {
                setTimeout(() => {
                    const responses = [
                        "Hey there! How are you?",
                        "I'm doing great! Thanks for asking.",
                        "What have you been up to?",
                        "That sounds interesting!",
                        "I miss you too!",
                        "Can't wait to see you again!",
                        "Thanks for the message!",
                        "You're the best! 💖"
                    ];
                    
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    const encryptedText = encryptMessage(randomResponse);
                    const now = new Date();
                    
                    const message = {
                        sender: otherUser,
                        text: encryptedText,
                        timestamp: now.getTime(),
                        status: '✓✓✓' // Read status
                    };
                    
                    // Add message to array
                    messages.push(message);
                    
                    // Save to localStorage
                    saveMessages();
                    
                    // Render messages
                    renderMessages(messages);
                    
                    // Show notification
                    showNotification(`New message from ${users[otherUser].name}`);
                    
                }, 2000 + Math.random() * 5000); // Random delay between 2-7 seconds
            }
        }

        // Handle message input keypress
        function handleMessageKeypress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // Toggle search
        function toggleSearch() {
            if (!searchContainer) return;
            searchContainer.classList.toggle('active');
            if (searchContainer.classList.contains('active')) {
                searchInput.focus();
            } else {
                searchInput.value = '';
                loadMessages();
            }
        }

        // Handle search
        function handleSearch() {
            renderMessages(messages);
        }

        // Toggle export menu
        function toggleExportMenu() {
            if (!exportMenu) return;
            exportMenu.classList.toggle('active');
        }

        // Toggle GIF picker
        function toggleGifPicker() {
            if (!gifPicker) return;
            gifPicker.classList.toggle('active');
        }

        // Populate GIF picker
        function populateGifPicker() {
            if (!gifPicker) return;
            
            gifPicker.innerHTML = '';
            
            popularGifs.forEach(gifUrl => {
                const gifItem = document.createElement('div');
                gifItem.classList.add('gif-item');
                gifItem.innerHTML = `<img src="${gifUrl}" alt="GIF">`;
                gifItem.addEventListener('click', () => sendGif(gifUrl));
                gifPicker.appendChild(gifItem);
            });
        }

        // Send GIF
        function sendGif(gifUrl) {
            const now = new Date();
            
            const message = {
                sender: currentUser,
                text: `GIF:${gifUrl}`,
                timestamp: now.getTime(),
                status: '✓✓' // Delivered status
            };
            
            // Add message to array
            messages.push(message);
            
            // Save to localStorage
            saveMessages();
            
            // Render messages
            renderMessages(messages);
            
            // Hide GIF picker
            gifPicker.classList.remove('active');
            
            // Simulate response after a delay
            simulateGifResponse();
        }

        // Simulate GIF response from other user
        function simulateGifResponse() {
            // Only simulate if the other user is Rina
            if (otherUser === 'rina') {
                setTimeout(() => {
                    const responseGifs = [
                        'https://media.giphy.com/media/3o7aTskHEUdgCQAXde/giphy.gif',
                        'https://media.giphy.com/media/3o7abAHdYvZdBNnGZq/giphy.gif',
                        'https://media.giphy.com/media/3o7aTskHEUdgCQAXde/giphy.gif',
                        'https://media.giphy.com/media/3o7abAHdYvZdBNnGZq/giphy.gif',
                        'https://media.giphy.com/media/3o7TKtbdpC5MnaYz8A/giphy.gif'
                    ];
                    
                    const randomGif = responseGifs[Math.floor(Math.random() * responseGifs.length)];
                    const now = new Date();
                    
                    const message = {
                        sender: otherUser,
                        text: `GIF:${randomGif}`,
                        timestamp: now.getTime(),
                        status: '✓✓✓' // Read status
                    };
                    
                    // Add message to array
                    messages.push(message);
                    
                    // Save to localStorage
                    saveMessages();
                    
                    // Render messages
                    renderMessages(messages);
                    
                    // Show notification
                    showNotification(`${users[otherUser].name} sent a GIF`);
                    
                }, 2000 + Math.random() * 5000); // Random delay between 2-7 seconds
            }
        }

        // Export chats
        function exportChats(format) {
            let exportData = '';
            
            if (format === 'html') {
                exportData = '<!DOCTYPE html><html><head><title>Chat Export</title><style>body{font-family: Arial, sans-serif; margin: 20px;} .message{margin-bottom: 15px;} .outgoing{text-align: right; color: blue;} .incoming{text-align: left; color: green;} .time{font-size: 12px; color: #666;}</style></head><body>';
                exportData += `<h1>Chat between ${users[currentUser].name} and ${users[otherUser].name}</h1>`;
                
                messages.forEach(msg => {
                    const time = formatTime(new Date(msg.timestamp));
                    const isOutgoing = msg.sender === currentUser;
                    
                    if (msg.text.startsWith('GIF:')) {
                        const gifUrl = msg.text.substring(4);
                        exportData += `
                            <div class="message ${isOutgoing ? 'outgoing' : 'incoming'}">
                                <div class="sender">${users[msg.sender].name}</div>
                                <img src="${gifUrl}" alt="GIF" style="max-width: 200px;">
                                <div class="time">${time}</div>
                            </div>
                        `;
                    } else {
                        const decryptedText = decryptMessage(msg.text);
                        exportData += `
                            <div class="message ${isOutgoing ? 'outgoing' : 'incoming'}">
                                <div class="sender">${users[msg.sender].name}</div>
                                <div class="text">${decryptedText}</div>
                                <div class="time">${time}</div>
                            </div>
                        `;
                    }
                });
                
                exportData += '</body></html>';
            } else if (format === 'text') {
                exportData = `Chat between ${users[currentUser].name} and ${users[otherUser].name}\n\n`;
                
                messages.forEach(msg => {
                    const time = formatTime(new Date(msg.timestamp));
                    const isOutgoing = msg.sender === currentUser;
                    const sender = users[msg.sender].name;
                    
                    if (msg.text.startsWith('GIF:')) {
                        exportData += `[${time}] ${sender}: [GIF]\n`;
                    } else {
                        const decryptedText = decryptMessage(msg.text);
                        exportData += `[${time}] ${sender}: ${decryptedText}\n`;
                    }
                });
            }
            
            // Create download link
            const blob = new Blob([exportData], { type: format === 'html' ? 'text/html' : 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_export_${new Date().toISOString().split('T')[0]}.${format === 'html' ? 'html' : 'txt'}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Hide export menu
            exportMenu.classList.remove('active');
            
            showNotification(`Chat exported as ${format.toUpperCase()}`);
        }

        // Handle logout
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear user data from localStorage
                localStorage.removeItem('currentUser');
                
                // Reset state
                currentUser = null;
                otherUser = null;
                
                // Show login screen
                showLoginScreen();
            }
        }

        // Show profile editor
        function showProfileEditor() {
            if (profileEditor && profilePreview) {
                profilePreview.src = currentUserAvatar.src;
                profileEditor.classList.add('active');
            }
        }

        // Hide profile editor
        function hideProfileEditor() {
            if (profileEditor) {
                profileEditor.classList.remove('active');
            }
        }

        // Trigger avatar upload
        function triggerAvatarUpload() {
            if (avatarUpload) {
                avatarUpload.click();
            }
        }

        // Handle avatar upload
        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file || !file.type.match('image.*')) {
                alert('Please select a valid image file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // Create a canvas to resize the image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Set canvas dimensions (max 200x200)
                    const maxSize = 200;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and resize image on canvas
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Get data URL
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Update avatar
                    if (currentUserAvatar) {
                        currentUserAvatar.src = dataUrl;
                    }
                    
                    // Save to localStorage
                    localStorage.setItem(`${currentUser}-avatar`, dataUrl);
                    
                    // Hide editor
                    hideProfileEditor();
                    
                    showNotification('Profile picture updated');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Simulate online status changes
        function simulateStatusChanges() {
            setInterval(() => {
                const isOnline = Math.random() > 0.3; // 70% chance online
                
                if (statusIndicator && statusText) {
                    if (isOnline) {
                        statusIndicator.classList.remove('offline');
                        statusIndicator.classList.add('online');
                        statusText.textContent = 'Online';
                    } else {
                        statusIndicator.classList.remove('online');
                        statusIndicator.classList.add('offline');
                        statusText.textContent = 'Offline';
                    }
                }
            }, 10000); // Change status every 10 seconds
        }

        // Initialize status simulation
        simulateStatusChanges();

        // Handle file attachment
        if (document.getElementById('attachment-btn')) {
            document.getElementById('attachment-btn').addEventListener('click', function() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '*/*';
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 10 * 1024 * 1024) { // 10MB limit
                            alert('File size too large. Maximum size is 10MB.');
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const now = new Date();
                            const message = {
                                sender: currentUser,
                                text: `FILE:${file.name}:${event.target.result}`,
                                timestamp: now.getTime(),
                                status: '✓✓',
                                file: {
                                    name: file.name,
                                    type: file.type,
                                    size: file.size,
                                    data: event.target.result
                                }
                            };
                            
                            // Add message to array
                            messages.push(message);
                            
                            // Save to localStorage
                            saveMessages();
                            
                            // Render messages
                            renderMessages(messages);
                            
                            showNotification('File sent');
                            
                            // Simulate file response
                            simulateFileResponse();
                        };
                        reader.readAsDataURL(file);
                    }
                });
                fileInput.click();
            });
        }

        // Simulate file response from other user
        function simulateFileResponse() {
            // Only simulate if the other user is Rina
            if (otherUser === 'rina') {
                setTimeout(() => {
                    const responses = [
                        "Thanks for the file!",
                        "I got your file, thank you!",
                        "This file is great, thanks!",
                        "I'll check out this file later.",
                        "Appreciate you sending this over!"
                    ];
                    
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    const encryptedText = encryptMessage(randomResponse);
                    const now = new Date();
                    
                    const message = {
                        sender: otherUser,
                        text: encryptedText,
                        timestamp: now.getTime(),
                        status: '✓✓✓' // Read status
                    };
                    
                    // Add message to array
                    messages.push(message);
                    
                    // Save to localStorage
                    saveMessages();
                    
                    // Render messages
                    renderMessages(messages);
                    
                    // Show notification
                    showNotification(`New message from ${users[otherUser].name}`);
                    
                }, 3000 + Math.random() * 4000); // Random delay between 3-7 seconds
            }
        }
    </script>
</body>
</html>